# PPT处理API系统使用说明

## 系统概述

PPT处理API系统是一个基于Flask的Web服务，专门用于将PowerPoint文件转换为图片格式。系统采用回调机制，支持异步处理，确保高效稳定的文件转换服务。

## 快速开始

### 1. 环境要求
- Windows操作系统
- Python 3.7+
- Microsoft PowerPoint（用于COM组件）
- 管理员权限（安装服务时需要）

### 2. 安装步骤

**步骤一：安装依赖**
```cmd
# 以管理员身份运行命令提示符
install_dependencies.bat
```

**步骤二：安装Windows服务**
```cmd
# 运行服务管理器
service_manager.bat
# 选择选项1安装服务，然后选择选项2启动服务
```

**步骤三：设置定时清理**
```cmd
# 在service_manager.bat中选择选项7创建定时任务
```

### 3. 基本使用

**启动回调服务器**（用于接收处理结果）：
```cmd
cd examples
python server.py
```

**上传PPT文件**：
```cmd
cd examples
python upload.py your_file.pptx http://localhost:8021/callback 1920 1080
```

## API接口说明

### 上传接口

**接口地址**: `POST http://localhost:8020/api/upload`

**请求参数**:
- `file`: PPT文件（必须）
- `callback_url`: 回调地址（必须）
- `width`: 图片宽度（可选，默认1920）
- `height`: 图片高度（可选，默认1080）

**请求示例**:
```bash
curl -X POST http://localhost:8020/api/upload \
  -F "file=@example.pptx" \
  -F "callback_url=http://your-server.com/callback" \
  -F "width=1920" \
  -F "height=1080"
```

**响应示例**:
```json
{
  "task_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "status": "pending",
  "message": "PPT conversion started, result will be sent to callback URL"
}
```

### 回调通知

处理完成后，系统会向指定的回调URL发送POST请求：

**成功回调数据**:
```json
{
  "task_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "status": "completed",
  "original_filename": "example.pptx",
  "filename": "a1b2c3d4-e5f6-7890-1234-567890abcdef.pptx",
  "created_at": 1640995200,
  "completed_at": 1640995260,
  "image_count": 10,
  "images": [
    {
      "slide": 1,
      "filename": "slide_1.png",
      "path": "/api/tasks/a1b2c3d4-e5f6-7890-1234-567890abcdef/images/slide_1.png"
    }
  ]
}
```

**失败回调数据**:
```json
{
  "task_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "status": "failed",
  "original_filename": "example.pptx",
  "filename": "a1b2c3d4-e5f6-7890-1234-567890abcdef.pptx",
  "created_at": 1640995200,
  "error": "错误描述"
}
```

## 客户端使用示例

### Python客户端

```python
import requests

# 上传文件
def upload_ppt(file_path, callback_url):
    url = "http://localhost:8020/api/upload"
    
    files = {'file': open(file_path, 'rb')}
    data = {
        'callback_url': callback_url,
        'width': 1920,
        'height': 1080
    }
    
    response = requests.post(url, files=files, data=data)
    return response.json()

# 使用示例
result = upload_ppt('example.pptx', 'http://your-server.com/callback')
print(f"任务ID: {result['task_id']}")
```

### JavaScript客户端

```javascript
// 上传文件
async function uploadPPT(file, callbackUrl) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('callback_url', callbackUrl);
    formData.append('width', '1920');
    formData.append('height', '1080');
    
    const response = await fetch('http://localhost:8020/api/upload', {
        method: 'POST',
        body: formData
    });
    
    return await response.json();
}

// 使用示例
const fileInput = document.getElementById('fileInput');
const file = fileInput.files[0];
const result = await uploadPPT(file, 'http://your-server.com/callback');
console.log('任务ID:', result.task_id);
```

## 服务管理

### 使用服务管理器

运行 `service_manager.bat` 可以进行以下操作：

1. **安装服务** - 将API安装为Windows服务
2. **启动服务** - 启动PPT处理服务
3. **停止服务** - 停止PPT处理服务
4. **重启服务** - 重启PPT处理服务
5. **卸载服务** - 卸载Windows服务
6. **查看状态** - 查看服务运行状态
7. **设置定时任务** - 创建每日清理任务
8. **删除定时任务** - 删除定时清理任务

### 手动管理

**查看服务状态**:
```cmd
sc query PPTProcessingService
```

**启动/停止服务**:
```cmd
net start PPTProcessingService
net stop PPTProcessingService
```

## 文件管理

### 目录结构
- `uploads/` - 上传的PPT文件（以UUID命名）
- `results/` - 处理结果图片（按任务ID分目录）
- `examples/` - 客户端示例代码

### 定时清理
系统每天凌晨2点自动清理uploads和results目录，释放磁盘空间。

### 手动清理
```cmd
python cleanup_script.py
```

## 故障排除

### 常见问题

**1. 服务无法启动**
- 确保以管理员身份运行
- 检查Python环境和依赖
- 查看服务日志 `ppt_service.log`

**2. 上传失败**
- 检查文件格式（仅支持.ppt和.pptx）
- 确认回调URL可访问
- 检查文件大小限制（100MB）

**3. 处理失败**
- 确认PowerPoint已安装
- 检查PPT文件是否损坏
- 查看API服务日志

**4. 回调未收到**
- 确认回调URL正确且可访问
- 检查网络连接
- 查看回调重试日志

### 日志文件
- `ppt_service.log` - 服务运行日志
- `cleanup_YYYYMMDD.log` - 清理任务日志

### 技术支持

如遇到技术问题，请提供：
1. 错误信息和日志
2. 操作步骤
3. 系统环境信息
4. PPT文件信息（如适用）

## 最佳实践

1. **回调URL设计**
   - 确保回调URL高可用
   - 实现幂等性处理
   - 添加适当的错误处理

2. **文件管理**
   - 定期监控磁盘空间
   - 根据需要调整清理频率
   - 重要文件及时备份

3. **性能优化**
   - 合理设置图片尺寸
   - 避免过大的PPT文件
   - 监控系统资源使用

4. **安全考虑**
   - 限制文件类型和大小
   - 验证回调URL合法性
   - 定期更新系统补丁
